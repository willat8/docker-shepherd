#!/bin/bash

curl -LO https://github.com/multiarch/qemu-user-static/releases/download/v6.1.0-5/qemu-aarch64-static
chmod +x qemu-aarch64-static
docker run --rm --privileged multiarch/qemu-user-static:register --reset

mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc
cat /proc/sys/fs/binfmt_misc/qemu-aarch64-static

# As per https://docs.docker.com/engine/reference/commandline/buildx_build/#allow
docker buildx create --use --name insecure-builder --buildkitd-flags '--allow-insecure-entitlement security.insecure'
docker buildx build --allow security.insecure --load --platform linux/arm64 -f "${DOCKERFILE_PATH:-Dockerfile}" -t "$IMAGE_NAME" .

